<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض صور حفلة النجاح</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* الأنماط الأساسية للجسم والخطوط والخلفية */
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f4f8;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            color: #333; /* لون نص افتراضي للجسم */
        }

        /* حاوية عرض الشرائح الرئيسية */
        .slideshow-container {
            position: relative;
            height: 100vh; /* ارتفاع كامل للشاشة */
            width: 100%;
            overflow: hidden;
            background-color: #000; /* خلفية سوداء افتراضية للشرائح */
        }

        /* نمط الشريحة الفردية */
        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0; /* مخفية في البداية */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white; /* لون النص الافتراضي للشرائح */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); /* ظل للنص لتحسين القراءة */
            /* أنماط افتراضية للخلفية إذا لم يتم تحديدها */
            background-size: cover;
            background-position: center;
            transition: all 1s ease-in-out; /* انتقال سلس للشفافية والتأثيرات الأخرى */
        }

        /* نمط الشريحة النشطة */
        .slide.active {
            opacity: 1; /* مرئية عند التنشيط */
            z-index: 1; /* لجعل الشريحة النشطة فوق الأخرى */
        }

        /* أنماط المؤثرات الانتقالية */
        .slide.fade-in {
            animation: fadeIn 1s forwards;
        }
        .slide.fade-out {
            animation: fadeOut 1s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .slide.slide-left {
            transform: translateX(100%);
        }
        .slide.active.slide-left {
            animation: slideInLeft 1s forwards;
        }
        @keyframes slideInLeft {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .slide.slide-right {
            transform: translateX(-100%);
        }
        .slide.active.slide-right {
            animation: slideInRight 1s forwards;
        }
        @keyframes slideInRight {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .slide.zoom-in {
            transform: scale(0.5);
            opacity: 0;
        }
        .slide.active.zoom-in {
            animation: zoomIn 1s forwards;
        }
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .slide.rotate-in {
            transform: rotateY(90deg);
            opacity: 0;
        }
        .slide.active.rotate-in {
            animation: rotateIn 1s forwards;
        }
        @keyframes rotateIn {
            from { transform: rotateY(90deg); opacity: 0; }
            to { transform: rotateY(0deg); opacity: 1; }
        }

        /* نمط الأزرار للتنقل بين الشرائح */
        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -22px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }

        .prev:hover, .next:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        /* نمط المؤشرات (النقاط) */
        .dots-container {
            text-align: center;
            position: absolute;
            bottom: 20px;
            width: 100%;
            z-index: 10;
        }

        .dot {
            cursor: pointer;
            height: 15px;
            width: 15px;
            margin: 0 2px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.6s ease;
        }

        .dot.active, .dot:hover {
            background-color: #717171;
        }

        /* أنماط خاصة لأنواع الشرائح */
        .slide.text-slide {
            background-color: rgba(0, 0, 0, 0.6); /* خلفية داكنة للنصوص */
            padding: 20px;
            text-align: center;
        }

        .slide.text-slide h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .slide.text-slide p {
            font-size: 1.5em;
        }

        .slide.student-slide {
            flex-direction: column;
            text-align: center;
            justify-content: center; /* توسيط عمودي */
            align-items: center; /* توسيط أفقي */
            background-color: rgba(0, 0, 0, 0.6); /* خلفية داكنة للطالب */
        }

        /* الصورة نفسها داخل شريحة الطالب */
        .slide.student-slide img {
            display: block; /* لجعلها تأخذ مساحة خاصة بها */
            margin: 0 auto 20px auto; /* توسيط الصورة مع هامش سفلي */
            border: 5px solid white; /* إطار أبيض حول الصورة */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); /* ظل خفيف */
        }

        /* نمط الصورة الدائرية للطالب */
        .student-image.circle {
            border-radius: 50%;
            width: 250px; /* حجم ثابت للدائرة */
            height: 250px; /* حجم ثابت للدائرة */
            object-fit: cover; /* لضمان ملء الصورة للدائرة */
        }

        /* نمط الصورة المستطيلة للطالب (4*6 تقريبي) */
        .student-image.rectangle {
            width: 250px; /* عرض تقديري */
            height: 375px; /* ارتفاع تقديري لنسبة 4:6 (إذا كان العرض 250، الارتفاع 250 * 1.5 = 375) */
            object-fit: cover; /* لضمان ملء الصورة للمستطيل */
        }

        .slide.image-slide {
            background-size: contain; /* لاحتواء الصورة داخل الشريحة بدون قص */
            background-repeat: no-repeat;
            background-position: center;
        }

        .slide.image-slide .image-caption {
            position: absolute;
            bottom: 50px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1.2em;
        }

        /* لوحة الإعدادات */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 350px; /* زيادة العرض */
            height: 100vh;
            background-color: #2d3748; /* خلفية داكنة للوحة التحكم */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
            padding: 20px;
            overflow-y: auto;
            z-index: 20;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            color: #e2e8f0; /* لون نص فاتح */
        }

        .settings-panel.open {
            transform: translateX(0);
        }

        .settings-toggle-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 21;
            background-color: #4a5568; /* لون زر الإعدادات */
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s ease;
        }

        .settings-toggle-btn:hover {
            background-color: #2d3748;
        }

        .settings-panel label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #cbd5e0; /* لون نص التسمية */
        }

        .settings-panel input[type="text"],
        .settings-panel input[type="number"],
        .settings-panel textarea,
        .settings-panel select,
        .settings-panel input[type="color"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #4a5568; /* حدود أغمق قليلاً */
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #1a202c; /* خلفية حقول الإدخال */
            color: #e2e8f0; /* لون نص حقول الإدخال */
        }

        .settings-panel input[type="file"] {
            color: #cbd5e0;
        }

        .settings-panel button {
            background-color: #4299e1; /* لون أزرق موحد للأزرار */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.2s ease;
        }

        .settings-panel button:hover {
            background-color: #3182ce;
        }

        /* ألوان مخصصة لبعض الأزرار */
        .settings-panel button.bg-green-600 { background-color: #38a169; }
        .settings-panel button.bg-green-600:hover { background-color: #2f855a; }
        .settings-panel button.bg-indigo-600 { background-color: #667eea; }
        .settings-panel button.bg-indigo-600:hover { background-color: #5a67d8; }
        .settings-panel button.bg-purple-600 { background-color: #805ad5; }
        .settings-panel button.bg-purple-600:hover { background-color: #6b46c1; }
        .settings-panel button.bg-orange-600 { background-color: #ed8936; }
        .settings-panel button.bg-orange-600:hover { background-color: #dd6b20; }
        .settings-panel button.bg-blue-500 { background-color: #4299e1; }
        .settings-panel button.bg-blue-500:hover { background-color: #3182ce; }
        .settings-panel button.bg-gray-500 { background-color: #a0aec0; }
        .settings-panel button.bg-gray-500:hover { background-color: #718096; }
        .settings-panel button.bg-teal-600 { background-color: #319795; }
        .settings-panel button.bg-teal-600:hover { background-color: #2c7a7b; }
        .settings-panel button.bg-yellow-600 { background-color: #d69e2e; }
        .settings-panel button.bg-yellow-600:hover { background-color: #b7791f; }
        .settings-panel button.bg-red-600 { background-color: #e53e3e; }
        .settings-panel button.bg-red-600:hover { background-color: #c53030; }


        .slides-list {
            margin-top: 20px;
            border-top: 1px solid #4a5568;
            padding-top: 10px;
        }

        .slides-list div {
            background-color: #1a202c; /* خلفية عناصر القائمة */
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #e2e8f0;
            border: 1px solid #4a5568;
        }

        .slides-list .slide-item-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        .slides-list .slide-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #667eea;
        }
        .slides-list .slide-thumbnail.circle {
            border-radius: 50%;
        }

        .slides-list .slide-controls button {
            width: auto;
            margin-left: 5px;
            padding: 5px 8px;
            background-color: #c53030; /* لون الحذف */
            font-size: 0.8em;
        }
        .slides-list .slide-controls button.move-btn {
            background-color: #4299e1; /* لون أزرار النقل */
        }
        .slides-list .slide-controls button:hover {
            opacity: 0.8;
        }


        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            font-size: 0.9em;
        }

        .message-box.show {
            opacity: 1;
        }

        .image-preview {
            max-width: 100%;
            max-height: 150px;
            display: block;
            margin-top: 10px;
            border: 1px solid #4a5568;
            border-radius: 4px;
        }

        /* التذييل */
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 0;
            text-align: center;
            font-size: 1em;
            z-index: 15;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* ألوان أقسام لوحة التحكم الداخلية */
        .settings-panel .p-3.border.rounded-lg {
            background-color: #1a202c; /* خلفية داخلية للقسم */
            border-color: #4a5568; /* حدود القسم */
        }
        .settings-panel .p-3.border.rounded-lg h3 {
            color: #cbd5e0; /* لون عنوان القسم */
        }
        .settings-panel .p-3.border.rounded-lg label {
            color: #a0aec0; /* لون التسميات داخل القسم */
        }
        .settings-panel .p-3.border.rounded-lg input,
        .settings-panel .p-3.border.rounded-lg textarea,
        .settings-panel .p-3.border.rounded-lg select {
            background-color: #2d3748; /* خلفية حقول الإدخال داخل القسم */
            color: #e2e8f0;
            border-color: #4a5568;
        }
        .settings-panel .p-3.border.rounded-lg input[type="file"] {
            color: #a0aec0;
        }
        .settings-panel .p-3.border.rounded-lg button {
            background-color: #4299e1;
            color: white;
        }

        .slideshow-container {
    background-color: #000; /* خلفية سوداء افتراضية للشرائح */
}
    </style>
</head>
<body>
    <div class="slideshow-container" id="slideshowContainer"></div>
    <div class="footer" id="mainFooter"></div>

    <div class="settings-toggle-btn" id="settingsToggleBtn">الإعدادات</div>

    <div class="settings-panel" id="settingsPanel">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">إعدادات العرض</h2>

        <div class="mb-4 p-3 border rounded-lg">
            <h3 class="font-semibold text-lg mb-2">الخلفية العامة</h3>
            <label for="backgroundImageUrlInput">رابط صورة الخلفية:</label>
            <input type="text" id="backgroundImageUrlInput" placeholder="أو ارفع ملفاً">
            <input type="file" id="backgroundFileInput" accept="image/*" class="mt-2 text-sm">
            <img id="backgroundPreview" class="image-preview" style="display: none;">
            <button id="updateBackgroundBtn" class="bg-green-600 hover:bg-green-700">تحديث الخلفية</button>
        </div>

        <div class="mb-4 p-3 border rounded-lg">
            <h3 class="font-semibold text-lg mb-2">إضافة شريحة طالب</h3>
            <label for="studentNameInput">اسم الطالب:</label>
            <input type="text" id="studentNameInput" placeholder="اسم الطالب">
            <label for="studentCommentInput">تعليق:</label>
            <textarea id="studentCommentInput" placeholder="تهانينا على تخرجه!"></textarea>
            <label for="studentImageUrlInput">رابط صورة الطالب:</label>
            <input type="text" id="studentImageUrlInput" placeholder="أو ارفع ملفاً">
            <input type="file" id="studentFileInput" accept="image/*" class="mt-2 text-sm">
            <img id="studentPreview" class="image-preview" style="display: none;">
            <label for="studentImageShapeInput">شكل الصورة:</label>
            <select id="studentImageShapeInput" class="text-sm">
                <option value="circle">دائرة (تركيز على الوجه)</option>
                <option value="rectangle">مستطيل (مثال: 4x6)</option>
            </select>
            <button id="addStudentBtn" class="bg-indigo-600 hover:bg-indigo-700">إضافة طالب</button>
        </div>

        <div class="mb-4 p-3 border rounded-lg">
            <h3 class="font-semibold text-lg mb-2">إضافة شريحة نصية</h3>
            <label for="textTitleInput">العنوان:</label>
            <input type="text" id="textTitleInput" placeholder="عنوان الشريحة">
            <label for="textCommentInput">النص:</label>
            <textarea id="textCommentInput" placeholder="نص الشريحة"></textarea>
            <button id="addTextSlideBtn" class="bg-purple-600 hover:bg-purple-700">إضافة شريحة نصية</button>
        </div>

        <div class="mb-4 p-3 border rounded-lg">
            <h3 class="font-semibold text-lg mb-2">إضافة شريحة صور عامة</h3>
            <label for="imageUrlInput">رابط الصورة:</label>
            <input type="text" id="imageUrlInput" placeholder="رابط الصورة">
            <input type="file" id="imageFileInput" accept="image/*" class="mt-2 text-sm">
            <img id="imagePreview" class="image-preview" style="display: none;">
            <label for="imageCaptionInput">وصف الصورة (اختياري):</label>
            <input type="text" id="imageCaptionInput" placeholder="وصف قصير للصورة">
            <label for="imageTitleInput">عنوان الصورة (اختياري):</label>
            <input type="text" id="imageTitleInput" placeholder="عنوان يظهر أعلى الصورة">
            <button id="addImageBtn" class="bg-orange-600 hover:bg-orange-700">إضافة صورة</button>
        </div>

        <div class="mb-4 p-3 border rounded-lg">
            <h3 class="font-semibold text-lg mb-2">الموسيقى الخلفية</h3>
            <label for="backgroundMusicUrl">رابط المادة الصوتية (MP3/WAV):</label>
            <input type="text" id="backgroundMusicUrl" placeholder="أو ارفع ملفاً">
            <input type="file" id="backgroundMusicFileInput" accept="audio/*" class="mt-2 text-sm">
            <div class="flex items-center gap-2 mt-2">
                <label for="musicVolume">مستوى الصوت:</label>
                <input type="range" id="musicVolume" min="0" max="1" step="0.01" value="0.5" class="flex-grow">
                <span id="volumeValue" class="text-sm">50%</span>
            </div>
            <div class="flex gap-2 mt-2">
                <button id="playMusicBtn" class="flex-1 bg-blue-500 hover:bg-blue-600">تشغيل</button>
                <button id="pauseMusicBtn" class="flex-1 bg-gray-500 hover:bg-gray-600">إيقاف مؤقت</button>
            </div>
            <audio id="backgroundMusic" loop></audio>
        </div>

        <div class="mb-4 p-3 border rounded-lg">
            <h3 class="font-semibold text-lg mb-2">التذييل (القدم)</h3>
            <label for="footerTextInput">نص التذييل:</label>
            <input type="text" id="footerTextInput" placeholder="مثال: حفلة تخرج الدفعة 2024">
            <label for="footerTextColorInput">لون نص التذييل:</label>
            <input type="color" id="footerTextColorInput" value="#FFFFFF">
            <label for="footerBgColorInput">لون خلفية التذييل:</label>
            <input type="color" id="footerBgColorInput" value="#000000">
            <button id="updateFooterBtn" class="bg-teal-600 hover:bg-teal-700">تحديث التذييل</button>
        </div>

        <div class="mb-4 p-3 border rounded-lg">
            <h3 class="font-semibold text-lg mb-2">التحكم بالشرائح والانتقالات</h3>
            <label for="slideDurationInput">مدة عرض الشريحة (ثواني):</label>
            <input type="number" id="slideDurationInput" value="5" min="1">

            <label class="mt-4">تأثيرات الانتقال:</label>
            <div id="transitionEffects" class="grid grid-cols-2 gap-2 text-sm">
                <label><input type="checkbox" value="fade-in" checked> تلاشي</label>
                <label><input type="checkbox" value="slide-left"> انزلاق لليسار</label>
                <label><input type="checkbox" value="slide-right"> انزلاق لليمين</label>
                <label><input type="checkbox" value="zoom-in"> تكبير</label>
                <label><input type="checkbox" value="rotate-in"> دوران</label>
            </div>
            <button id="applyTransitionEffectsBtn" class="bg-blue-500 hover:bg-blue-600">تطبيق تأثيرات الانتقال</button>
        </div>
        <div class="mb-4 p-3 border rounded-lg">
            <h3 class="font-semibold text-lg mb-2 text-gray-200">التحكم بالعرض التقديمي</h3>
            <button id="startSlideshowBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full mb-2">بدء العرض</button>
            <button id="stopSlideshowBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded w-full">إيقاف العرض</button>
        </div>
        <button id="saveSettingsBtn" class="bg-blue-600 hover:bg-blue-700">حفظ الإعدادات</button>
        <button id="loadDefaultsBtn" class="bg-yellow-600 hover:bg-yellow-700">تحميل إعدادات افتراضية</button>
        <button id="clearAllBtn" class="bg-red-600 hover:bg-red-700">مسح كل الشرائح</button>
        <div class="slides-list" id="slidesList">
            <h3 class="font-semibold text-lg mb-2">الشرائح المضافة:</h3>
            </div>
            
        <div class="flex flex-wrap justify-between gap-2 mt-4">
                <button id="exportSettingsBtn" class="bg-purple-600 hover:bg-purple-700 flex-grow">حفظ العرض (JSON)</button>
                <input type="file" id="loadFileInput" accept=".json" class="hidden"> <button id="loadFromFileBtn" class="bg-teal-600 hover:bg-teal-700 flex-grow">تحميل من ملف (JSON)</button> </div>
         </div>

    <div class="message-box" id="messageBox"></div>

    <script>
        const slideshowContainer = document.getElementById('slideshowContainer');
        const settingsToggleBtn = document.getElementById('settingsToggleBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const startSlideshowBtn = document.getElementById('startSlideshowBtn');
        const stopSlideshowBtn = document.getElementById('stopSlideshowBtn');
        const SETTINGS_FILE_PATH = 'settings.json'; // المسار الافتراضي لملف الإعدادات

        // عناصر التحكم بالطلاب
        const studentNameInput = document.getElementById('studentNameInput');
        const studentCommentInput = document.getElementById('studentCommentInput');
        const studentImageUrlInput = document.getElementById('studentImageUrlInput');
        const studentFileInput = document.getElementById('studentFileInput');
        const studentPreview = document.getElementById('studentPreview');
        const studentImageShapeInput = document.getElementById('studentImageShapeInput');
        const addStudentBtn = document.getElementById('addStudentBtn');

        // عناصر التحكم بالنصوص
        const textTitleInput = document.getElementById('textTitleInput');
        const textCommentInput = document.getElementById('textCommentInput');
        const addTextSlideBtn = document.getElementById('addTextSlideBtn');

        // عناصر التحكم بالصور العامة
        const imageUrlInput = document.getElementById('imageUrlInput');
        const imageFileInput = document.getElementById('imageFileInput');
        const imagePreview = document.getElementById('imagePreview');
        const imageCaptionInput = document.getElementById('imageCaptionInput');
        const imageTitleInput = document.getElementById('imageTitleInput');
        const addImageBtn = document.getElementById('addImageBtn');

        // عناصر التحكم بالمدة والحفظ
        const slideDurationInput = document.getElementById('slideDurationInput');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const loadDefaultsBtn = document.getElementById('loadDefaultsBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        // أزرار التصدير والاستيراد
// أزرار الحفظ والتحميل من ملف
        const exportSettingsBtn = document.getElementById('exportSettingsBtn');
        const loadFileInput = document.getElementById('loadFileInput'); // يجب أن يكون هذا loadFileInput
        const loadFromFileBtn = document.getElementById('loadFromFileBtn'); // يجب أن يكون هذا loadFromFileBtn
        const slidesList = document.getElementById('slidesList');
        const messageBox = document.getElementById('messageBox');
        startSlideshowBtn.addEventListener('click', () => {
            if (slides.length > 0) {
                currentSlideIndex = 0; // NEW: ابدأ من الشريحة الأولى
                showSlide(currentSlideIndex); // NEW: اعرض الشريحة الأولى
                startSlideshow(); // ابدأ العرض التلقائي

                // تشغيل الموسيقى
                if (backgroundMusicElement.src) { // <--- تم تعديل الشرط هنا
                    backgroundMusicElement.currentTime = 0; // إعادة تعيين وقت الموسيقى للبداية
                    backgroundMusicElement.play().catch(e => {
                        displayMessage('فشل تشغيل الموسيقى تلقائيًا. الرجاء التشغيل يدوياً.', true);
                        console.error("خطأ في تشغيل الموسيقى:", e);
                    });
                }
                displayMessage('تم بدء العرض والموسيقى.');
            } else {
                displayMessage('لا توجد شرائح لبدء العرض. الرجاء إضافة شرائح أولاً.', true);
            }
        });

        stopSlideshowBtn.addEventListener('click', () => {
            clearInterval(slideshowInterval); // إيقاف عرض الشرائح
            backgroundMusicElement.pause(); // إيقاف الموسيقى
            displayMessage('تم إيقاف العرض والموسيقى.');
        });

        // عناصر التحكم بالخلفية العامة
        const backgroundImageUrlInput = document.getElementById('backgroundImageUrlInput');
        const backgroundFileInput = document.getElementById('backgroundFileInput');
        const backgroundPreview = document.getElementById('backgroundPreview');
        const updateBackgroundBtn = document.getElementById('updateBackgroundBtn');

        // عناصر التحكم بالموسيقى
        const backgroundMusicElement = document.getElementById('backgroundMusic');
        const backgroundMusicUrlInput = document.getElementById('backgroundMusicUrl');
        const backgroundMusicFileInput = document.getElementById('backgroundMusicFileInput');
        const musicVolumeControl = document.getElementById('musicVolume');
        const volumeValue = document.getElementById('volumeValue');
        const playMusicBtn = document.getElementById('playMusicBtn');
        const pauseMusicBtn = document.getElementById('pauseMusicBtn');

        // عناصر التحكم بالتذييل
        const mainFooter = document.getElementById('mainFooter');
        const footerTextInput = document.getElementById('footerTextInput');
        const footerTextColorInput = document.getElementById('footerTextColorInput');
        const footerBgColorInput = document.getElementById('footerBgColorInput');
        const updateFooterBtn = document.getElementById('updateFooterBtn');

        // عناصر التحكم بتأثيرات الانتقال
        const transitionEffectsContainer = document.getElementById('transitionEffects');
        const applyTransitionEffectsBtn = document.getElementById('applyTransitionEffectsBtn');

        let slides = [];
        let currentSlideIndex = 0;
        let slideshowInterval;
        let slideDuration = 5000; // 5 ثواني افتراضية
        let selectedTransitionEffects = ['fade-in']; // التأثير الافتراضي

        const allTransitionEffects = [
            'fade-in',
            'slide-left',
            'slide-right',
            'zoom-in',
            'rotate-in'
        ];

        // وظائف مساعدة لعرض الرسائل
        function displayMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.style.backgroundColor = isError ? 'rgba(220, 53, 69, 0.8)' : 'rgba(0, 0, 0, 0.8)';
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // وظيفة لإضافة صورة إلى سلايد
        function addImage(imageUrl, caption = '', title = '') {
            slides.push({
                type: 'image',
                imageUrl: imageUrl,
                caption: caption,
                title: title,
                effect: selectedTransitionEffects[0] // تعيين أول مؤثر افتراضيًا
            });
            updateSlidesList();
            displayMessage('تم إضافة شريحة صورة بنجاح.');
        }

        // وظيفة لإضافة شريحة طالب
        function addStudent(name, comment, imageUrl, imageShape) {
            slides.push({
                type: 'student',
                name: name,
                comment: comment,
                imageUrl: imageUrl,
                imageShape: imageShape,
                effect: selectedTransitionEffects[0] // تعيين أول مؤثر افتراضيًا
            });
            updateSlidesList();
            displayMessage('تم إضافة شريحة طالب بنجاح.');
        }

        // وظيفة لإضافة شريحة نصية
        function addTextSlide(title, comment) {
            slides.push({
                type: 'text',
                title: title,
                comment: comment,
                effect: selectedTransitionEffects[0] // تعيين أول مؤثر افتراضيًا
            });
            updateSlidesList();
            displayMessage('تم إضافة شريحة نصية بنجاح.');
        }

        function stopSlideshow() {
            clearInterval(slideshowInterval);
        }
        
        // وظيفة عرض الشرائح
        function showSlide(index) {
            if (slides.length === 0) {
                slideshowContainer.innerHTML = '<div class="slide active flex flex-col justify-center items-center text-gray-400 text-2xl font-bold">لا توجد شرائح لعرضها. أضف شرائح من لوحة الإعدادات أو حمل الإعدادات الافتراضية.</div>';
                // إخفاء الأزرار والمؤشرات إذا لم تكن هناك شرائح
                document.querySelector('.prev')?.remove();
                document.querySelector('.next')?.remove();
                document.querySelector('.dots-container')?.remove();
                return;
            }

            const allSlides = document.querySelectorAll('.slide');
            allSlides.forEach(slide => {
                // إزالة جميع تأثيرات الانتقال قبل إضافة الشريحة الجديدة
                allTransitionEffects.forEach(effect => slide.classList.remove(effect));
                slide.classList.remove('active', 'fade-in', 'fade-out', 'slide-left', 'slide-right', 'zoom-in', 'rotate-in'); // تأكد من إزالة كل الفئات
                slide.style.opacity = 0; // إخفاء الشريحة غير النشطة
                slide.style.transform = 'none'; // إعادة ضبط التحويلات
            });

            // إزالة جميع الشرائح الموجودة وإعادة بنائها لمنع تداخل التأثيرات القديمة
            slideshowContainer.innerHTML = '';

            const slideData = slides[index];
            const slideElement = document.createElement('div');
            slideElement.classList.add('slide');

            // تطبيق خلفية عامة إذا كانت موجودة
            const storedSettings = JSON.parse(localStorage.getItem('slideshowSettings'));
            if (storedSettings && storedSettings.backgroundImageUrl) {
                slideElement.style.backgroundImage = `url('${storedSettings.backgroundImageUrl}')`;
            }

            if (slideData.type === 'student') {
                slideElement.classList.add('student-slide');
                const studentImage = document.createElement('img');
                studentImage.src = slideData.imageUrl;
                studentImage.alt = slideData.name;
                if (slideData.imageShape === 'circle') {
                    studentImage.classList.add('student-image', 'circle');
                } else if (slideData.imageShape === 'rectangle') {
                    studentImage.classList.add('student-image', 'rectangle');
                }
                slideElement.appendChild(studentImage);

                const studentInfo = document.createElement('div');
                studentInfo.classList.add('student-info', 'p-4', 'bg-black/50', 'rounded-lg', 'mt-4');
                const studentName = document.createElement('h2');
                studentName.classList.add('text-4xl', 'font-bold', 'mb-2');
                studentName.textContent = slideData.name;
                const studentComment = document.createElement('p');
                studentComment.classList.add('text-xl');
                studentComment.textContent = slideData.comment;
                studentInfo.appendChild(studentName);
                studentInfo.appendChild(studentComment);
                slideElement.appendChild(studentInfo);

            } else if (slideData.type === 'text') {
                slideElement.classList.add('text-slide');
                const title = document.createElement('h2');
                title.textContent = slideData.title;
                const comment = document.createElement('p');
                comment.textContent = slideData.comment;
                slideElement.appendChild(title);
                slideElement.appendChild(comment);
            } else if (slideData.type === 'image') {
                slideElement.classList.add('image-slide');
                slideElement.style.backgroundImage = `url('${slideData.imageUrl}')`;
                slideElement.style.backgroundSize = 'contain';
                slideElement.style.backgroundRepeat = 'no-repeat';
                slideElement.style.backgroundPosition = 'center';

                if (slideData.title) {
                    const titleElement = document.createElement('h2');
                    titleElement.textContent = slideData.title;
                    titleElement.style.position = 'absolute';
                    titleElement.style.top = '50px';
                    titleElement.style.zIndex = '1';
                    titleElement.classList.add('text-4xl', 'font-bold');
                    slideElement.appendChild(titleElement);
                }

                if (slideData.caption) {
                    const captionElement = document.createElement('div');
                    captionElement.classList.add('image-caption');
                    captionElement.textContent = slideData.caption;
                    slideElement.appendChild(captionElement);
                }
            }

            slideshowContainer.appendChild(slideElement);

            // تطبيق تأثير الانتقال
            let effectToApply = 'fade-in'; // التأثير الافتراضي إذا لم يتم تحديد شيء
            if (selectedTransitionEffects.length > 0) {
                // اختيار عشوائي من التأثيرات المحددة
                effectToApply = selectedTransitionEffects[Math.floor(Math.random() * selectedTransitionEffects.length)];
            }
            slideElement.classList.add('active', effectToApply);

            // تحديث المؤشرات (النقاط) والأزرار
            updateNavigationControls();
        }

        function testImage(url, callback) {
    const img = new Image();
    img.onload = function() { callback(true); };
    img.onerror = function() { callback(false); };
    img.src = url;
}

       // وظيفة للانتقال للشريحة التالية
        function nextSlide() {
            currentSlideIndex = (currentSlideIndex + 1) % slides.length;
            showSlide(currentSlideIndex);
        }

        // وظيفة للانتقال للشريحة السابقة
        function prevSlide() {
            currentSlideIndex = (currentSlideIndex - 1 + slides.length) % slides.length;
            showSlide(currentSlideIndex);
        }

        // وظيفة لبدء عرض الشرائح التلقائي
        function startSlideshow() {
            clearInterval(slideshowInterval); // مسح أي فاصل زمني سابق
            if (slides.length > 0) {
                slideDuration = parseInt(slideDurationInput.value) * 1000;
                slideshowInterval = setInterval(nextSlide, slideDuration);
            }
        }

        // وظيفة تحديث قائمة الشرائح في لوحة الإعدادات
        function updateSlidesList() {
            slidesList.innerHTML = '<h3 class="font-semibold text-lg mb-2">الشرائح المضافة:</h3>';
            if (slides.length === 0) {
                slidesList.innerHTML += '<p class="text-gray-400 text-sm">لا توجد شرائح مضافة بعد.</p>';
            }
            slides.forEach((slide, index) => {
                const slideItem = document.createElement('div');
                let slideText = '';
                let thumbnailHtml = '';

                if (slide.type === 'student') {
                    slideText = `طالب: ${slide.name}`;
                    thumbnailHtml = `<img src="${slide.imageUrl}" alt="صورة الطالب" class="slide-thumbnail ${slide.imageShape}">`;
                } else if (slide.type === 'text') {
                    slideText = `نص: ${slide.title || 'شريحة نصية'}`;
                    thumbnailHtml = `<span class="slide-thumbnail flex items-center justify-center bg-blue-700 text-white text-xs">نص</span>`;
                } else if (slide.type === 'image') {
                    slideText = `صورة: ${slide.caption || 'صورة عامة'}`;
                    thumbnailHtml = `<img src="${slide.imageUrl}" alt="صورة" class="slide-thumbnail">`;
                }

                slideItem.innerHTML = `
                    <div class="slide-item-content">
                        ${thumbnailHtml}
                        <span>${index + 1}. ${slideText}</span>
                    </div>
                    <div class="slide-controls flex gap-1">
                        <button class="move-btn bg-blue-500 hover:bg-blue-600" data-index="${index}" data-direction="up" title="نقل للأعلى">⬆️</button>
                        <button class="move-btn bg-blue-500 hover:bg-blue-600" data-index="${index}" data-direction="down" title="نقل للأسفل">⬇️</button>
                        <button class="bg-red-600 hover:bg-red-700" data-index="${index}" title="حذف الشريحة">🗑️</button>
                    </div>
                `;
                slidesList.appendChild(slideItem);
            });

            // إضافة مستمعي الأحداث لأزرار الحذف والتحريك
            slidesList.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    if (e.target.textContent.includes('🗑️')) { // زر الحذف
                        slides.splice(index, 1);
                        if (currentSlideIndex >= slides.length && slides.length > 0) {
                            currentSlideIndex = slides.length - 1;
                        } else if (slides.length === 0) {
                            currentSlideIndex = 0;
                        }
                        displayMessage('تم حذف الشريحة.');
                    } else if (e.target.dataset.direction === 'up') { // زر النقل للأعلى
                        if (index > 0) {
                            [slides[index], slides[index - 1]] = [slides[index - 1], slides[index]];
                            if (currentSlideIndex === index) currentSlideIndex--;
                            else if (currentSlideIndex === index - 1) currentSlideIndex++;
                            displayMessage('تم نقل الشريحة للأعلى.');
                        } else {
                            displayMessage('هذه الشريحة بالفعل في الأعلى.', true);
                        }
                    } else if (e.target.dataset.direction === 'down') { // زر النقل للأسفل
                        if (index < slides.length - 1) {
                            [slides[index], slides[index + 1]] = [slides[index + 1], slides[index]];
                            if (currentSlideIndex === index) currentSlideIndex++;
                            else if (currentSlideIndex === index + 1) currentSlideIndex--;
                            displayMessage('تم نقل الشريحة للأسفل.');
                        } else {
                            displayMessage('هذه الشريحة بالفعل في الأسفل.', true);
                        }
                    }
                    updateSlidesList();
                    showSlide(currentSlideIndex); // تحديث العرض بعد التعديل
                });
            });
            showSlide(currentSlideIndex); // تحديث العرض مباشرة بعد التعديل على القائمة
            startSlideshow(); // إعادة تشغيل عرض الشرائح للتأكد من تحديث المؤقت
        }

        // وظيفة تحديث المؤشرات (النقاط) وأزرار التنقل
        function updateNavigationControls() {
            // تحديث المؤشرات (النقاط)
            let dotsContainer = document.querySelector('.dots-container');
            if (!dotsContainer) {
                dotsContainer = document.createElement('div');
                dotsContainer.classList.add('dots-container');
                slideshowContainer.appendChild(dotsContainer);
            }
            dotsContainer.innerHTML = ''; // مسح النقاط القديمة

            if (slides.length > 0) {
                for (let i = 0; i < slides.length; i++) {
                    const dot = document.createElement('span');
                    dot.classList.add('dot');
                    if (i === currentSlideIndex) {
                        dot.classList.add('active');
                    }
                    dot.addEventListener('click', () => {
                        currentSlideIndex = i;
                        showSlide(currentSlideIndex);
                        startSlideshow(); // إعادة تشغيل المؤقت عند الانتقال اليدوي
                    });
                    dotsContainer.appendChild(dot);
                }
                dotsContainer.style.display = 'block'; // إظهار النقاط
            } else {
                dotsContainer.style.display = 'none'; // إخفاء النقاط إذا لم تكن هناك شرائح
            }

            // إضافة أزرار التنقل إذا لم تكن موجودة وإظهارها/إخفائها
            let prevBtn = document.querySelector('.prev');
            let nextBtn = document.querySelector('.next');

            if (slides.length > 1) { // إظهار الأزرار فقط إذا كان هناك أكثر من شريحة واحدة
                if (!prevBtn) {
                    prevBtn = document.createElement('a');
                    prevBtn.classList.add('prev');
                    prevBtn.innerHTML = '&#10094;';
                    prevBtn.addEventListener('click', () => {
                        prevSlide();
                        startSlideshow();
                    });
                    slideshowContainer.appendChild(prevBtn);
                }
                if (!nextBtn) {
                    nextBtn = document.createElement('a');
                    nextBtn.classList.add('next');
                    nextBtn.innerHTML = '&#10095;';
                    nextBtn.addEventListener('click', () => {
                        nextSlide();
                        startSlideshow();
                    });
                    slideshowContainer.appendChild(nextBtn);
                }
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
            } else { // إخفاء الأزرار إذا كانت شريحة واحدة أو لا توجد شرائح
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            }
        }
        // دالة لتصدير الإعدادات (الشرائح) إلى ملف JSON
// دالة لحفظ الإعدادات الحالية إلى ملف JSON يمكن تنزيله
            function saveSettingsToFile() {
    const settingsToSave = {
        slides: slides,
        background: {
            url: backgroundImageUrlInput.value,
        },
        music: {
            url: backgroundMusicUrlInput.value,
            volume: musicVolumeControl.value
        },
        footer: {
            text: footerTextInput.value,
            textColor: footerTextColorInput.value,
            bgColor: footerBgColorInput.value
        },
        currentSlideIndex: currentSlideIndex,
        slideDuration: slideDurationInput.value,
        transitionEffects: selectedTransitionEffects,
    };

    const dataStr = JSON.stringify(settingsToSave, null, 4);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'عرض_النجاح_الإعدادات.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    displayMessage('تم حفظ إعدادات العرض كملف JSON.');
}

        // وظيفة لتحميل الإعدادات الافتراضية
        function loadDefaultSettings() {
            slides = []; // مسح الشرائح الحالية
            backgroundImageUrlInput.value = ''; // مسح خلفية عامة
            document.body.style.backgroundImage = 'none';
            backgroundPreview.style.display = 'none';

            // إعادة تعيين إعدادات الموسيقى والتذييل
            backgroundMusicUrlInput.value = '';
            backgroundMusicElement.pause();
            backgroundMusicElement.src = '';
            musicVolumeControl.value = 0.5;
            volumeValue.textContent = '50%';
            footerTextInput.value = 'حفل تخرجنا 2024';
            footerTextColorInput.value = '#FFFFFF';
            footerBgColorInput.value = '#000000';
            updateFooter();
            selectedTransitionEffects = ['fade-in', 'slide-left']; // تأثيرات افتراضية للخلط
            updateTransitionCheckboxes();

            // إضافة طلاب افتراضيين (بصور Placeholder وأشكال مختلفة)
            addStudent("محمد أحمد", "مبروك التخرج!", "https://via.placeholder.com/250/0000FF/FFFFFF?text=M.A", "circle");
            addStudent("سارة علي", "متفوقة في العلوم", "https://via.placeholder.com/250x375/FF0000/FFFFFF?text=S.A", "rectangle");
            addStudent("خالد سعيد", "نجم الحفل", "https://via.placeholder.com/250/00FF00/FFFFFF?text=K.S", "circle");
            addStudent("فاطمة ناصر", "المستقبل واعد", "https://via.placeholder.com/250x375/FFFF00/000000?text=F.N", "rectangle");

            addTextSlide("تهانينا!", "نتمنى لكم دوام التوفيق والنجاح.");
            addTextSlide("ألف مبروك التخرج!", "نفخر بإنجازاتكم ونتمنى لكم كل التوفيق في مسيرتكم القادمة.");

            addImage('https://via.placeholder.com/800x600/0000FF/FFFFFF?text=Slide%201', 'صورة رقم 1', 'احتفال الطلاب');
            addImage('https://via.placeholder.com/800x600/FF0000/FFFFFF?text=Slide%202', 'صورة رقم 2', 'ذكريات جميلة');
            addImage('https://via.placeholder.com/800x600/00FF00/FFFFFF?text=Slide%203', 'صورة رقم 3', 'لحظات لا تنسى');


            slideDurationInput.value = 5; // إعادة ضبط المدة الافتراضية
            updateSlidesList();
            displayMessage('تم تحميل الإعدادات الافتراضية بنجاح.');
            startSlideshow(); // بدء العرض
        }

        // وظيفة لمسح جميع الشرائح والإعدادات
        function clearAllSlides() {
            slides = [];
            currentSlideIndex = 0;
            slideshowContainer.innerHTML = '<div class="slide active flex flex-col justify-center items-center text-gray-400 text-2xl font-bold">لا توجد شرائح لعرضها. أضف شرائح من لوحة الإعدادات، حمل الإعدادات الافتراضية، أو حمل عرضًا من ملف JSON.</div>';
            //localStorage.removeItem('slideshowSettings');//
            updateSlidesList();
            stopSlideshow();
            updateTransitionCheckboxes();;
            showSlide(currentSlideIndex); // عرض رسالة "لا توجد شرائح"
            backgroundImageUrlInput.value = '';
            document.body.style.backgroundImage = 'none';
            backgroundPreview.style.display = 'none';
            musicVolumeControl.value = 0.5;
            volumeValue.textContent = '50%';
            slideDurationInput.value = 5;
            footerTextInput.value = '';
            footerTextColorInput.value = '#FFFFFF';
            footerBgColorInput.value = '#000000';
            slideshowContainer.style.backgroundImage = 'none';
            slideshowContainer.style.backgroundSize = '';
            slideshowContainer.style.backgroundPosition = '';
            slideshowContainer.style.backgroundRepeat = '';
            loadDefaultSettings();
            updateFooter();
            selectedTransitionEffects = ['fade-in']; // إعادة تعيين التأثيرات
            updateTransitionCheckboxes();

            displayMessage('تم مسح جميع الشرائح والإعدادات.');
        }

        // معالجة رفع الملفات للصور والموسيقى
        function handleFileUpload(fileInput, urlInput, previewElement = null) {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        urlInput.value = event.target.result; // تعيين رابط الصورة كـ base64
                        if (previewElement) {
                            previewElement.src = event.target.result;
                            previewElement.style.display = 'block';
                        }
                        if (fileInput.id === 'backgroundMusicFileInput') {
                            backgroundMusicElement.src = event.target.result;
                            backgroundMusicElement.play().catch(e => console.error("فشل تشغيل الموسيقى بعد الرفع:", e));
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    urlInput.value = '';
                    if (previewElement) {
                        previewElement.style.display = 'none';
                    }
                    if (fileInput.id === 'backgroundMusicFileInput') {
                        backgroundMusicElement.pause();
                        backgroundMusicElement.src = '';
                    }
                }
            });

            // تحديث المعاينة عند تغيير الرابط يدوياً (للتأكد من أنها لا تزال تعمل بشكل صحيح)
            urlInput.addEventListener('input', () => {
                if (urlInput.value) {
                    if (previewElement) {
                        previewElement.src = urlInput.value;
                        previewElement.style.display = 'block';
                    }
                    if (urlInput.id === 'backgroundMusicUrl') {
                        backgroundMusicElement.src = urlInput.value;
                        backgroundMusicElement.play().catch(e => console.error("فشل تشغيل الموسيقى بعد تغيير الرابط:", e));
                    }
                } else {
                    if (previewElement) {
                        previewElement.style.display = 'none';
                    }
                    if (urlInput.id === 'backgroundMusicUrl') {
                        backgroundMusicElement.pause();
                        backgroundMusicElement.src = '';
                    }
                }
            });
        }

function updateBackground() {
    const imageUrl = backgroundImageUrlInput.value.trim();
    const file = backgroundFileInput.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            slideshowContainer.style.backgroundImage = `url('${e.target.result}')`;
            slideshowContainer.style.backgroundSize = 'cover';
            slideshowContainer.style.backgroundPosition = 'center';
            slideshowContainer.style.backgroundRepeat = 'no-repeat';
            backgroundPreview.src = e.target.result;
            backgroundPreview.style.display = 'block';
            displayMessage('تم تحديث خلفية العرض من ملف.');
        };
        reader.readAsDataURL(file);
    } else if (imageUrl) {
        slideshowContainer.style.backgroundImage = `url('${imageUrl}')`;
        slideshowContainer.style.backgroundSize = 'cover';
        slideshowContainer.style.backgroundPosition = 'center';
        slideshowContainer.style.backgroundRepeat = 'no-repeat';
        backgroundPreview.src = imageUrl;
        backgroundPreview.style.display = 'block';
        displayMessage('تم تحديث خلفية العرض من رابط.');
    } else {
        slideshowContainer.style.backgroundImage = 'none';
        slideshowContainer.style.backgroundSize = '';
        slideshowContainer.style.backgroundPosition = '';
        slideshowContainer.style.backgroundRepeat = '';
        backgroundPreview.style.display = 'none';
        backgroundPreview.src = '';
        displayMessage('تم إزالة خلفية العرض.');
    }
}

        // دالة لتحميل الإعدادات من ملف يختاره المستخدم
function loadSettingsFromFile(event) {
    const file = event.target.files[0];
    if (!file) {
        displayMessage('الرجاء تحديد ملف JSON للتحميل.', true);
        return;
    }

    const reader = new FileReader();

    reader.onload = (e) => {
        try {
            const importedSettings = JSON.parse(e.target.result);

            if (importedSettings && Array.isArray(importedSettings.slides)) {
                slides = [];
                importedSettings.slides.forEach(s => slides.push(s));

                currentSlideIndex = importedSettings.currentSlideIndex || 0;

                // استعادة الخلفية
                if (importedSettings.background && importedSettings.background.url) {
                    backgroundImageUrlInput.value = importedSettings.background.url;
                    updateBackground();
                }

                // استعادة إعدادات الموسيقى
                if (importedSettings.music) {
                    backgroundMusicUrlInput.value = importedSettings.music.url || '';
                    musicVolumeControl.value = importedSettings.music.volume || 0.5;
                    volumeValue.textContent = `${Math.round((importedSettings.music.volume || 0.5) * 100)}%`;
                    if (importedSettings.music.url) {
                        backgroundMusicElement.src = importedSettings.music.url;
                    }
                }

                // استعادة إعدادات التذييل
                if (importedSettings.footer) {
                    footerTextInput.value = importedSettings.footer.text || '';
                    footerTextColorInput.value = importedSettings.footer.textColor || '#FFFFFF';
                    footerBgColorInput.value = importedSettings.footer.bgColor || '#000000';
                    updateFooter();
                }

                if (importedSettings.slideDuration) {
                    slideDurationInput.value = importedSettings.slideDuration;
                }

                if (importedSettings.transitionEffects && Array.isArray(importedSettings.transitionEffects)) {
                    selectedTransitionEffects = importedSettings.transitionEffects;
                    updateTransitionCheckboxes();
                }

                updateSlidesList();
                showSlide(currentSlideIndex);
                startSlideshow();

                displayMessage('تم تحميل الإعدادات من الملف بنجاح!');
            } else {
                displayMessage('ملف JSON الذي تم تحميله غير صالح أو لا يحتوي على بيانات الشرائح.', true);
            }
        } catch (error) {
            console.error('خطأ في تحليل ملف JSON:', error);
            displayMessage('حدث خطأ أثناء تحميل الملف. تأكد من أنه ملف JSON صالح.', true);
        }
    };

    reader.onerror = () => {
        displayMessage('حدث خطأ أثناء قراءة الملف.', true);
    };

    reader.readAsText(file);
}

        // دالة لحفظ الإعدادات الحالية إلى ملف JSON يمكن تنزيله
            function exportCurrentSettings() {
                const settingsToSave = {
                    slides: slides,
                    background: {
                        url: backgroundImageUrlInput.value,
                    },
     
                    music: {
                    url: backgroundMusicUrlInput.value,
                    volume: musicVolumeControl.value
                   },

                   footer: {
                   text: footerTextInput.value,
                   textColor: footerTextColorInput.value,
                   bgColor: footerBgColorInput.value
                  },
                   currentSlideIndex: currentSlideIndex,
                    slideDuration: slideDurationInput.value,
                    transitionEffects: selectedTransitionEffects,
                };

                const dataStr = JSON.stringify(settingsToSave, null, 4);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'عرض_النجاح_الإعدادات.json'; // اسم الملف الافتراضي
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                displayMessage('تم حفظ إعدادات العرض كملف JSON.');
            }

        // وظيفة لتحديث التذييل
        function updateFooter() {
            mainFooter.textContent = footerTextInput.value;
            mainFooter.style.color = footerTextColorInput.value;
            mainFooter.style.backgroundColor = footerBgColorInput.value;
            if (footerTextInput.value.trim() === '') {
                mainFooter.style.display = 'none';
            } else {
                mainFooter.style.display = 'block';
            }
        }

        // وظيفة للحصول على التأثيرات المختارة من مربعات الاختيار
        function getSelectedTransitionEffects() {
            const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // وظيفة لتحديث مربعات اختيار التأثيرات بناءً على selectedTransitionEffects
        function updateTransitionCheckboxes() {
            const checkboxes = transitionEffectsContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = selectedTransitionEffects.includes(cb.value);
            });
        }


// ربط معالجات رفع الملفات بعناصر الواجهة
handleFileUpload(backgroundFileInput, backgroundImageUrlInput, backgroundPreview);
handleFileUpload(studentFileInput, studentImageUrlInput, studentPreview);
handleFileUpload(imageFileInput, imageUrlInput, imagePreview);
handleFileUpload(backgroundMusicFileInput, backgroundMusicUrlInput);

// إضافة مستمعي الأحداث للأزرار
settingsToggleBtn.addEventListener('click', () => {
    settingsPanel.classList.toggle('open');
});

addStudentBtn.addEventListener('click', () => {
    const name = studentNameInput.value.trim();
    const comment = studentCommentInput.value.trim();
    const imageUrl = studentImageUrlInput.value.trim();
    const imageShape = studentImageShapeInput.value;
    if (name && imageUrl) {
        addStudent(name, comment, imageUrl, imageShape);
        studentNameInput.value = '';
        studentCommentInput.value = '';
        studentImageUrlInput.value = '';
        studentFileInput.value = '';
        studentPreview.style.display = 'none';
    } else {
        displayMessage('الرجاء إدخال اسم الطالب ورابط الصورة.', true);
    }
});

addTextSlideBtn.addEventListener('click', () => {
    const title = textTitleInput.value.trim();
    const comment = textCommentInput.value.trim();
    if (title || comment) {
        addTextSlide(title, comment);
        textTitleInput.value = '';
        textCommentInput.value = '';
    } else {
        displayMessage('الرجاء إدخال عنوان أو نص للشريحة.', true);
    }
});

addImageBtn.addEventListener('click', () => {
    const url = imageUrlInput.value.trim();
    const caption = imageCaptionInput.value.trim();
    const imgTitle = imageTitleInput.value.trim();
    if (url) {
        addImage(url, caption, imgTitle);
        imageUrlInput.value = '';
        imageCaptionInput.value = '';
        imageTitleInput.value = '';
        imageFileInput.value = '';
        imagePreview.style.display = 'none';
    } else {
        displayMessage('الرجاء إدخال رابط الصورة.', true);
    }
});

    const bgUrl = backgroundImageUrlInput.value.trim();
    if (bgUrl) {
        document.body.style.backgroundImage = `url('${bgUrl}')`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        displayMessage('تم تحديث خلفية العرض.');
    } else {
        document.body.style.backgroundImage = 'none';
        displayMessage('تم إزالة خلفية العرض.');
    }

    // مستمعي أحداث الموسيقى
musicVolumeControl.addEventListener('input', () => {
    backgroundMusicElement.volume = musicVolumeControl.value;
    volumeValue.textContent = `${Math.round(backgroundMusicElement.volume * 100)}%`;
});

playMusicBtn.addEventListener('click', () => {
    if (backgroundMusicElement.src) {
        backgroundMusicElement.play().catch(e => {
            displayMessage('فشل تشغيل الموسيقى. قد يكون المتصفح يمنع التشغيل التلقائي.', true);
            console.error("خطأ في تشغيل الموسيقى:", e);
        });
    } else {
        displayMessage('لا يوجد رابط لمادة صوتية. الرجاء إضافة رابط أو رفع ملف.', true);
    }
});

        pauseMusicBtn.addEventListener('click', () => {
            backgroundMusicElement.pause();
        });

        // مستمعي أحداث التذييل
        updateFooterBtn.addEventListener('click', () => {
            updateFooter();
            displayMessage('تم تحديث التذييل.');
});

// مستمعي أحداث تأثيرات الانتقال
applyTransitionEffectsBtn.addEventListener('click', () => {
    selectedTransitionEffects = getSelectedTransitionEffects();
    if (selectedTransitionEffects.length === 0) {
        displayMessage('الرجاء اختيار تأثير انتقال واحد على الأقل. سيتم استخدام "تلاشي" افتراضيًا.', true);
        selectedTransitionEffects = ['fade-in'];
        updateTransitionCheckboxes();
    }
    displayMessage('تم تطبيق تأثيرات الانتقال المختارة.');
});

loadDefaultsBtn.addEventListener('click', loadDefaultSettings);
clearAllBtn.addEventListener('click', clearAllSlides);
exportSettingsBtn.addEventListener('click', exportCurrentSettings);
loadFromFileBtn.addEventListener('click', () => loadFileInput.click());
loadFileInput.addEventListener('change', loadSettingsFromFile);
slideDurationInput.addEventListener('change', startSlideshow);

        // ربط زر تحديث الخلفية
        updateBackgroundBtn.addEventListener('click', updateBackground); // تأكد من وجود هذا السطر

        document.addEventListener('DOMContentLoaded', () => {
            // قم بتهيئة الشرائح كفارغة عند بدء التشغيل
            slides = []; // تأكد أن مصفوفة الشرائح فارغة
            currentSlideIndex = 0; // إعادة تعيين فهرس الشريحة

            // عرض الرسالة التوجيهية عند بدء التشغيل
            slideshowContainer.innerHTML = '<div class=\"slide active flex flex-col justify-center items-center text-gray-400 text-2xl font-bold\">لا توجد شرائح لعرضها. أضف شرائح من لوحة الإعدادات، حمل الإعدادات الافتراضية، أو حمل عرضًا من ملف JSON.</div>';
            updateSlidesList(); // لتحديث قائمة الشرائح في لوحة التحكم لتظهر "لا توجد شرائح"
            stopSlideshow(); // تأكد من إيقاف أي عرض تلقائي إذا كان يعمل

            // تهيئة واجهة المستخدم والإعدادات الافتراضية
            updateTransitionCheckboxes(); // لتطبيق الافتراضيات الافتراضية (مثل "fade-in")
            
            // تهيئة حقول الخلفية لجعلها فارغة عند البدء
            backgroundImageUrlInput.value = '';
            document.body.style.setProperty('background-image', 'none', 'important'); // مسح أي خلفية سابقة مع أولوية قصوى
            document.body.style.backgroundSize = ''; // مسح أنماط الحجم
            document.body.style.backgroundPosition = ''; // مسح أنماط الموضع
            document.body.style.backgroundRepeat = ''; // مسح أنماط التكرار
            backgroundPreview.style.display = 'none'; // إخفاء معاينة الخلفية
            backgroundPreview.src = ''; // مسح مصدر معاينة الخلفية

            slideDurationInput.value = 5; // يمكن تعيين مدة افتراضية هنا

            // استدعاء loadDefaultSettings() لتهيئة القيم الافتراضية للعناصر
            loadDefaultSettings(); 
        });
   
    </script>
</body>
</html>
